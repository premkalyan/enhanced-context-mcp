{
  "name": "VISHKAR 17-Step Enhanced SDLC",
  "version": "2.0.0",
  "description": "Enhanced development lifecycle with 4-angle internal review after task implementation",
  "philosophy": "Quality at source - review early, fix early",

  "overview": {
    "purpose": "Enable autonomous agents to execute the full software development lifecycle with minimal human intervention",
    "total_steps": 17,
    "human_gates": 1,
    "automated_steps": 16,
    "key_enhancement": "4-Angle Internal Review (Steps 3-6) after implementation catches issues before testing",
    "quality_thresholds": {
      "minimum_quality_score": 7,
      "test_pass_rate": 90,
      "max_retries": 3,
      "escalation_trigger": "After 3 failed retries, escalate to human",
      "critical_issues_allowed": 0,
      "high_issues_allowed": 0
    }
  },

  "severity_levels": [
    {
      "level": "critical",
      "symbol": "red_circle",
      "description": "Security vulnerabilities, production-breaking issues",
      "action": "MUST fix before proceeding",
      "blocking": true
    },
    {
      "level": "high",
      "symbol": "orange_circle",
      "description": "Performance issues, significant maintainability concerns",
      "action": "MUST fix before proceeding",
      "blocking": true
    },
    {
      "level": "medium",
      "symbol": "yellow_circle",
      "description": "Code quality improvements, best practice suggestions",
      "action": "SHOULD fix, recommended",
      "blocking": false
    },
    {
      "level": "low",
      "symbol": "green_circle",
      "description": "Style preferences, minor optimizations",
      "action": "MAY fix, or log for future",
      "blocking": false
    }
  ],

  "contextual_agent_selection": {
    "description": "Rules for selecting the right agent based on file patterns being reviewed",
    "usage": "When Step 6 (Tech-Stack Review) runs, select agent based on files being changed",
    "rules": [
      {
        "pattern": "backend/**/*.py",
        "agents": ["a-fastapi-pro", "a-backend-engineer"],
        "description": "Python backend files"
      },
      {
        "pattern": "frontend/**/*.tsx",
        "agents": ["a-frontend-developer", "a-typescript-pro"],
        "description": "React TypeScript components"
      },
      {
        "pattern": "frontend/**/*.ts",
        "agents": ["a-typescript-pro"],
        "description": "TypeScript files"
      },
      {
        "pattern": "frontend/**/*.js",
        "agents": ["a-javascript-pro"],
        "description": "JavaScript files"
      },
      {
        "pattern": "**/*.jsx",
        "agents": ["a-frontend-developer", "a-javascript-pro"],
        "description": "React JSX components"
      },
      {
        "pattern": "docker/**/*",
        "agents": ["a-deployment-engineer"],
        "description": "Docker configuration"
      },
      {
        "pattern": "**/Dockerfile*",
        "agents": ["a-deployment-engineer"],
        "description": "Dockerfile"
      },
      {
        "pattern": "**/*.yml",
        "agents": ["a-deployment-engineer"],
        "description": "YAML configuration files"
      },
      {
        "pattern": "**/*.yaml",
        "agents": ["a-deployment-engineer"],
        "description": "YAML configuration files"
      },
      {
        "pattern": "terraform/**/*",
        "agents": ["a-terraform-specialist"],
        "description": "Terraform IaC files"
      },
      {
        "pattern": "**/*.tf",
        "agents": ["a-terraform-specialist"],
        "description": "Terraform files"
      },
      {
        "pattern": "tests/**/*",
        "agents": ["a-test-automator"],
        "description": "Test files"
      },
      {
        "pattern": "**/*test*.py",
        "agents": ["a-test-automator"],
        "description": "Python test files"
      },
      {
        "pattern": "**/*spec*.ts",
        "agents": ["a-test-automator"],
        "description": "TypeScript spec files"
      },
      {
        "pattern": "**/api/**/*",
        "agents": ["a-backend-architect", "a-backend-engineer"],
        "description": "API endpoints"
      },
      {
        "pattern": "**/components/**/*",
        "agents": ["a-frontend-developer"],
        "description": "UI components"
      },
      {
        "pattern": "**/hooks/**/*",
        "agents": ["a-frontend-developer"],
        "description": "React hooks"
      },
      {
        "pattern": "**/*.sql",
        "agents": ["a-backend-engineer"],
        "description": "SQL files"
      },
      {
        "pattern": "**/migrations/**/*",
        "agents": ["a-backend-engineer"],
        "description": "Database migrations"
      },
      {
        "pattern": "**/*.prisma",
        "agents": ["a-backend-engineer"],
        "description": "Prisma schema"
      }
    ],
    "default_agent": "a-backend-engineer"
  },

  "mcp_servers": {
    "vercel_hosted": [
      {
        "name": "Project Registry",
        "url": "https://project-registry-henna.vercel.app",
        "howto": "https://project-registry-henna.vercel.app/api/howto",
        "purpose": "API key management and credential storage"
      },
      {
        "name": "JIRA MCP",
        "url": "https://jira-mcp-pi.vercel.app",
        "howto": "https://jira-mcp-pi.vercel.app/api/howto",
        "purpose": "Issue tracking, sprint management, story lifecycle",
        "used_in_steps": [1, 17]
      },
      {
        "name": "Confluence MCP",
        "url": "https://confluence-mcp-six.vercel.app",
        "howto": "https://confluence-mcp-six.vercel.app/api/howto",
        "purpose": "Documentation, architecture diagrams, test reports",
        "used_in_steps": [17]
      },
      {
        "name": "Enhanced Context MCP",
        "url": "https://enhanced-context-mcp.vercel.app",
        "howto": "https://enhanced-context-mcp.vercel.app/api/howto",
        "purpose": "Context loading, agent discovery, SDLC guidance, contextual agent selection",
        "used_in_steps": "All steps"
      },
      {
        "name": "Story Crafter MCP",
        "url": "https://storycrafter-mcp.vercel.app",
        "howto": "https://storycrafter-mcp.vercel.app/api/howto",
        "purpose": "Backlog generation from VISHKAR consensus",
        "used_in_steps": [1]
      }
    ],
    "docker_local": [
      {
        "name": "PR-Agent MCP",
        "url": "http://localhost:8188",
        "port": 8188,
        "purpose": "AI-powered PR review, code analysis, security scanning",
        "used_in_steps": [13],
        "setup": {
          "start": "cd /path/to/pr-agent-mcp && docker-compose up -d",
          "stop": "docker-compose down",
          "health": "http://localhost:8188/health"
        },
        "note": "Code review MCP runs on local Docker for security - keeps code analysis local"
      }
    ]
  },

  "agent_mapping": {
    "pm_agent": {
      "wama_agent_ids": ["a-project-manager"],
      "owned_steps": [1, 17],
      "responsibilities": ["Story selection", "Story completion", "Sprint management"]
    },
    "dev_agent": {
      "wama_agent_ids": ["a-backend-engineer", "a-frontend-developer", "a-fullstack-developer"],
      "owned_steps": [2, 8, 12, 14],
      "responsibilities": ["Implementation", "Manual verification", "PR creation", "Feedback implementation"]
    },
    "review_agent_architecture": {
      "wama_agent_ids": ["a-architect-review"],
      "owned_steps": [3],
      "responsibilities": ["System design review", "Component boundaries", "Scalability assessment"]
    },
    "review_agent_security": {
      "wama_agent_ids": ["a-security-auditor"],
      "owned_steps": [4],
      "responsibilities": ["Security vulnerability detection", "OWASP compliance", "Auth review"]
    },
    "review_agent_quality": {
      "wama_agent_ids": ["a-code-reviewer"],
      "owned_steps": [5],
      "responsibilities": ["Code quality assessment", "SOLID principles", "Clean code"]
    },
    "review_agent_techstack": {
      "wama_agent_ids": ["contextual"],
      "owned_steps": [6],
      "responsibilities": ["Framework-specific review", "Performance patterns", "Best practices"],
      "agent_selection": "Use contextual_agent_selection rules based on file patterns"
    },
    "qa_agent": {
      "wama_agent_ids": ["a-test-automator", "a-qa-engineer"],
      "owned_steps": [9, 10, 11],
      "responsibilities": ["Test case creation", "Test implementation", "Test execution"]
    },
    "pr_review_agent": {
      "wama_agent_ids": ["a-pr-orchestrator"],
      "owned_steps": [13],
      "responsibilities": ["Formal PR review orchestration", "Cross-agent coordination"]
    },
    "coordinator": {
      "wama_agent_ids": ["a-architect-review"],
      "owned_steps": "All (monitoring)",
      "responsibilities": ["Cross-step monitoring", "Escalation handling", "Quality oversight"]
    }
  },

  "steps": [
    {
      "step": 1,
      "name": "Task Selection",
      "short_name": "Task -> In Progress",
      "phase": "Task Selection",
      "owner_agent": "PM Agent",
      "wama_agents": ["a-project-manager"],
      "automated": true,
      "gate": null,
      "description": "Select task from JIRA backlog and move to In Progress",
      "entry_criteria": [
        "Tasks exist in Ready column",
        "No blockers on candidate tasks",
        "Sprint has capacity"
      ],
      "exit_criteria": [
        "Task moved to In Progress",
        "Task has acceptance criteria",
        "Dependencies are resolved",
        "Feature branch created"
      ],
      "actions": [
        "Query JIRA for ready tasks",
        "Select highest priority task",
        "Check acceptance criteria completeness",
        "Verify dependencies resolved",
        "Transition task to In Progress",
        "Create feature branch"
      ],
      "outputs": ["task_id", "branch_name"],
      "jira_transition": "To Do -> In Progress",
      "mcp_tools": {
        "jira_mcp": ["search_issues", "get_issue_details", "transition_issue", "add_comment"],
        "enhanced_context_mcp": ["load_enhanced_context", "list_vishkar_agents"]
      },
      "handoff": {
        "to": "Dev Agent",
        "payload": ["taskKey", "acceptanceCriteria", "branchName"]
      }
    },
    {
      "step": 2,
      "name": "Implementation",
      "short_name": "Implementation",
      "phase": "Implementation",
      "owner_agent": "Dev Agent",
      "wama_agents": ["a-backend-engineer", "a-frontend-developer"],
      "automated": true,
      "gate": null,
      "description": "Implement the task following coding standards",
      "entry_criteria": [
        "Task in In Progress",
        "Acceptance criteria understood",
        "Feature branch created",
        "Lessons learned loaded as context"
      ],
      "exit_criteria": [
        "Code implemented",
        "Linting passes",
        "TypeScript/type checks pass",
        "Self-quality score >= 7/10"
      ],
      "actions": [
        "Load lessons learned from .reviews/lessons_learned.json",
        "Analyze acceptance criteria",
        "Write implementation code",
        "Follow project conventions",
        "Add inline documentation",
        "Run linting and type checks"
      ],
      "outputs": ["changed_files[]", "implementation_summary"],
      "context_loading": {
        "lessons_file": ".reviews/lessons_learned.json",
        "purpose": "Load previous review lessons to prevent repeated mistakes"
      },
      "mcp_tools": {
        "enhanced_context_mcp": ["load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Review Agent (Architecture)",
        "payload": ["branchName", "changedFiles", "qualityScore"]
      }
    },
    {
      "step": 3,
      "name": "Architecture Review",
      "short_name": "Arch Review",
      "phase": "4-Angle Internal Review",
      "owner_agent": "Review Agent (Architecture)",
      "wama_agents": ["a-architect-review"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": "0 Critical, 0 High issues",
        "action_on_fail": "Return to Step 2 with findings"
      },
      "description": "Review system design and architectural implications",
      "mandatory": true,
      "entry_criteria": [
        "Implementation complete",
        "Changed files identified"
      ],
      "exit_criteria": [
        "Architecture review complete",
        "No critical architectural issues",
        "Findings documented"
      ],
      "focus_areas": [
        "System design patterns",
        "Component boundaries",
        "Scalability implications",
        "Integration points",
        "Technical debt assessment",
        "Dependency management"
      ],
      "blocking_on": ["critical", "high"],
      "outputs": ["architecture_findings[]"],
      "mcp_tools": {
        "enhanced_context_mcp": ["load_vishkar_agent", "load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Review Agent (Security)",
        "payload": ["architectureFindings", "changedFiles"]
      }
    },
    {
      "step": 4,
      "name": "Security Review",
      "short_name": "Security Review",
      "phase": "4-Angle Internal Review",
      "owner_agent": "Review Agent (Security)",
      "wama_agents": ["a-security-auditor"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": "0 Critical, 0 High issues",
        "action_on_fail": "Return to Step 2 with findings"
      },
      "description": "Review for security vulnerabilities and compliance",
      "mandatory": true,
      "entry_criteria": [
        "Architecture review complete or in parallel"
      ],
      "exit_criteria": [
        "Security review complete",
        "No security vulnerabilities",
        "Findings documented"
      ],
      "focus_areas": [
        "OWASP Top 10 vulnerabilities",
        "Authentication/Authorization",
        "Input validation and sanitization",
        "Secrets management",
        "SQL injection, XSS, CSRF",
        "API security patterns",
        "Data encryption"
      ],
      "blocking_on": ["critical", "high"],
      "outputs": ["security_findings[]"],
      "mcp_tools": {
        "enhanced_context_mcp": ["load_vishkar_agent", "load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Review Agent (Quality)",
        "payload": ["securityFindings", "changedFiles"]
      }
    },
    {
      "step": 5,
      "name": "Code Quality Review",
      "short_name": "Quality Review",
      "phase": "4-Angle Internal Review",
      "owner_agent": "Review Agent (Quality)",
      "wama_agents": ["a-code-reviewer"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": "0 Critical, 0 High issues",
        "action_on_fail": "Return to Step 2 with findings"
      },
      "description": "Review for code quality and maintainability",
      "mandatory": true,
      "entry_criteria": [
        "Security review complete or in parallel"
      ],
      "exit_criteria": [
        "Code quality review complete",
        "No critical quality issues",
        "Findings documented"
      ],
      "focus_areas": [
        "SOLID principles adherence",
        "Clean code practices",
        "DRY principle",
        "Error handling patterns",
        "Logging and observability",
        "Code organization",
        "Naming conventions"
      ],
      "blocking_on": ["critical", "high"],
      "outputs": ["quality_findings[]"],
      "mcp_tools": {
        "enhanced_context_mcp": ["load_vishkar_agent", "load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Review Agent (Tech-Stack)",
        "payload": ["qualityFindings", "changedFiles"]
      }
    },
    {
      "step": 6,
      "name": "Tech-Stack Review",
      "short_name": "Tech Review",
      "phase": "4-Angle Internal Review",
      "owner_agent": "Review Agent (Tech-Stack)",
      "wama_agents": ["contextual"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": "0 Critical, 0 High issues",
        "action_on_fail": "Return to Step 2 with findings"
      },
      "description": "Review for technology-specific best practices",
      "mandatory": true,
      "agent_selection": {
        "method": "contextual",
        "description": "Select agent based on file patterns being changed",
        "use_rules": "contextual_agent_selection"
      },
      "entry_criteria": [
        "Code quality review complete or in parallel"
      ],
      "exit_criteria": [
        "Tech-stack review complete",
        "No critical tech-specific issues",
        "Findings documented"
      ],
      "focus_areas": [
        "Framework-specific patterns",
        "Performance optimization",
        "Async patterns (if applicable)",
        "Database query optimization",
        "Caching strategies",
        "API design patterns"
      ],
      "blocking_on": ["critical", "high"],
      "outputs": ["tech_findings[]", "selected_agent"],
      "mcp_tools": {
        "enhanced_context_mcp": ["get_contextual_agent", "load_vishkar_agent", "load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Dev Agent (Feedback)",
        "payload": ["techFindings", "selectedAgent", "allFindings"]
      }
    },
    {
      "step": 7,
      "name": "Feedback Implementation & Storage",
      "short_name": "Fix Findings",
      "phase": "Feedback",
      "owner_agent": "Dev Agent",
      "wama_agents": ["a-backend-engineer", "a-frontend-developer"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": "0 Critical, 0 High issues remaining",
        "action_on_fail": "Retry up to 3 times, then escalate"
      },
      "description": "Address findings from 4-angle review and store for LLM learning",
      "entry_criteria": [
        "All 4 reviews complete",
        "Findings consolidated"
      ],
      "exit_criteria": {
        "critical_count": 0,
        "high_count": 0,
        "findings_stored": true,
        "lessons_updated": true
      },
      "actions": [
        "Fix all Critical issues",
        "Fix all High issues",
        "Address Medium issues (recommended)",
        "Document Low issues for backlog",
        "Store findings to .reviews/findings/{task_id}_findings.json",
        "Update .reviews/lessons_learned.json with new patterns"
      ],
      "retry_logic": {
        "max_retries": 3,
        "on_retry": "Re-run reviews 3-6 after fixes",
        "on_exceeded": "Escalate to human"
      },
      "storage": {
        "findings_per_task": ".reviews/findings/{task_id}_findings.json",
        "lessons_aggregated": ".reviews/lessons_learned.json",
        "purpose": "LLM learning - prevent repeated mistakes"
      },
      "mcp_tools": {
        "enhanced_context_mcp": ["load_enhanced_context"],
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Dev Agent (Manual Verification)",
        "payload": ["fixedIssues", "remainingIssues", "lessonsUpdated"]
      }
    },
    {
      "step": 8,
      "name": "Manual Verification",
      "short_name": "Manual Verify",
      "phase": "Testing",
      "owner_agent": "Dev Agent",
      "wama_agents": ["a-backend-engineer", "a-frontend-developer"],
      "automated": true,
      "gate": "Optional",
      "description": "Developer verifies implementation works locally",
      "entry_criteria": [
        "All Critical/High issues fixed",
        "Review findings addressed"
      ],
      "exit_criteria": [
        "Application starts without errors",
        "Acceptance criteria verified",
        "Edge cases tested manually",
        "No regressions found"
      ],
      "actions": [
        "Run application locally",
        "Verify acceptance criteria",
        "Test edge cases manually",
        "Verify no regressions"
      ],
      "mcp_tools": {
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "QA Agent",
        "payload": ["verificationStatus", "issuesFound"]
      }
    },
    {
      "step": 9,
      "name": "Create Test Cases",
      "short_name": "Create Tests",
      "phase": "Testing",
      "owner_agent": "QA Agent",
      "wama_agents": ["a-test-automator"],
      "automated": true,
      "gate": null,
      "description": "Define test scenarios for the implementation in TCM-ready format",
      "entry_criteria": [
        "Manual verification passed",
        "Acceptance criteria available"
      ],
      "exit_criteria": [
        "Test cases defined",
        "Positive/negative cases covered",
        "Edge cases included",
        "Test cases stored in JSON format"
      ],
      "actions": [
        "Identify test scenarios from AC",
        "Define positive test cases",
        "Define negative test cases",
        "Define edge cases",
        "Store test cases in JSON format (for future TCM)"
      ],
      "outputs": ["test_cases.json"],
      "storage": {
        "location": "tests/cases/{task_id}.json",
        "format": "TCM-compatible JSON"
      },
      "mcp_tools": {
        "jira_mcp": ["get_issue_details"],
        "enhanced_context_mcp": ["load_enhanced_context"]
      },
      "handoff": {
        "to": "QA Agent (Implement)",
        "payload": ["testCases", "testCasesPath"]
      }
    },
    {
      "step": 10,
      "name": "Implement Tests",
      "short_name": "Implement Tests",
      "phase": "Testing",
      "owner_agent": "QA Agent",
      "wama_agents": ["a-test-automator"],
      "automated": true,
      "gate": null,
      "description": "Write automated tests based on test cases",
      "entry_criteria": [
        "Test cases defined",
        "Test environment available"
      ],
      "exit_criteria": [
        "Unit tests implemented",
        "Integration tests implemented",
        "Coverage threshold met"
      ],
      "actions": [
        "Write unit tests (pytest/jest)",
        "Write integration tests",
        "Add test annotations for reporting",
        "Ensure coverage meets threshold"
      ],
      "coverage_threshold": 80,
      "mcp_tools": {
        "enhanced_context_mcp": ["load_enhanced_context"]
      },
      "handoff": {
        "to": "QA Agent (Execute)",
        "payload": ["testFiles", "testCount"]
      }
    },
    {
      "step": 11,
      "name": "Execute Tests",
      "short_name": "Run Tests",
      "phase": "Testing",
      "owner_agent": "QA Agent",
      "wama_agents": ["a-test-automator"],
      "automated": true,
      "gate": {
        "type": "Quality Gate",
        "threshold": ">=90% pass rate, >=80% coverage",
        "action_on_fail": "Retry up to 3 times, then escalate"
      },
      "description": "Run full test suite and verify quality threshold",
      "entry_criteria": [
        "Tests implemented",
        "Test environment ready"
      ],
      "exit_criteria": [
        "All tests executed",
        "Pass rate >= 90%",
        "Coverage >= 80%",
        "Test report generated"
      ],
      "actions": [
        "Run pytest/jest with coverage",
        "Generate coverage report",
        "Generate test report (Allure if configured)",
        "Verify all tests pass"
      ],
      "pass_criteria": {
        "all_tests_pass": true,
        "pass_rate_minimum": 90,
        "coverage_minimum": 80
      },
      "mcp_tools": {
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Dev Agent (PR)",
        "payload": ["passRate", "coverage", "testReport"]
      }
    },
    {
      "step": 12,
      "name": "PR Creation",
      "short_name": "Create PR",
      "phase": "PR & Review",
      "owner_agent": "Dev Agent",
      "wama_agents": ["a-backend-engineer", "a-frontend-developer"],
      "automated": true,
      "gate": null,
      "description": "Create pull request with review checklist",
      "entry_criteria": [
        "Tests passing (>=90%)",
        "Coverage >= 80%",
        "Branch up to date with target"
      ],
      "exit_criteria": [
        "PR created",
        "Proper commit format",
        "Description includes context",
        "Linked to JIRA task"
      ],
      "actions": [
        "Push branch to remote",
        "Rebase on target branch if needed",
        "Create PR with template",
        "Include test results",
        "Link JIRA task"
      ],
      "pr_template": {
        "sections": [
          "Summary of changes",
          "JIRA link",
          "Test results",
          "Screenshots (if UI)",
          "Checklist"
        ]
      },
      "commit_format": "{PROJECT}-{number}: {summary}",
      "mcp_tools": {
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "PR Review Agent",
        "payload": ["prUrl", "branchName", "testResults"]
      }
    },
    {
      "step": 13,
      "name": "PR Review (Formal)",
      "short_name": "PR Review",
      "phase": "PR & Review",
      "owner_agent": "PR Review Agent",
      "wama_agents": ["a-pr-orchestrator"],
      "automated": true,
      "gate": null,
      "description": "Formal PR review orchestrated across relevant agents",
      "entry_criteria": [
        "PR created",
        "CI checks initiated"
      ],
      "exit_criteria": [
        "PR review complete",
        "Review feedback documented",
        "Approval received or changes requested"
      ],
      "actions": [
        "Orchestrate review across relevant agents",
        "Run PR-Agent describe/review/improve",
        "Collect reviewer feedback",
        "Request changes if needed"
      ],
      "review_phases": [
        {
          "phase": 1,
          "name": "PR Describe",
          "tool": "pr_describe",
          "description": "Generate comprehensive PR description"
        },
        {
          "phase": 2,
          "name": "PR Review",
          "tool": "pr_review",
          "description": "Security, performance, quality analysis"
        },
        {
          "phase": 3,
          "name": "PR Improve",
          "tool": "pr_improve",
          "description": "Improvement suggestions ranked by impact"
        }
      ],
      "mcp_tools": {
        "pr_agent_mcp_docker": ["pr_describe", "pr_review", "pr_improve"],
        "note": "PR-Agent MCP runs on LOCAL DOCKER (port 8188)"
      },
      "handoff": {
        "to": "Dev Agent (Feedback)",
        "payload": ["reviewComments", "approvalStatus"]
      }
    },
    {
      "step": 14,
      "name": "PR Feedback Implementation",
      "short_name": "Fix PR Feedback",
      "phase": "PR & Review",
      "owner_agent": "Dev Agent",
      "wama_agents": ["a-backend-engineer", "a-frontend-developer"],
      "automated": true,
      "gate": null,
      "description": "Address PR review comments",
      "entry_criteria": [
        "PR review feedback received"
      ],
      "exit_criteria": [
        "All review comments addressed",
        "Tests re-run and passing",
        "Re-review requested"
      ],
      "actions": [
        "Address reviewer comments",
        "Push updates",
        "Re-run tests",
        "Request re-review"
      ],
      "mcp_tools": {
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "CI/CD Pipeline",
        "payload": ["updatedPR", "testsRerun"]
      }
    },
    {
      "step": 15,
      "name": "CI/CD Pipeline",
      "short_name": "CI/CD",
      "phase": "Merge & Deploy",
      "owner_agent": "CI/CD (Automated)",
      "wama_agents": [],
      "automated": "Semi (external system)",
      "gate": {
        "type": "Quality Gate",
        "threshold": "All checks green",
        "action_on_fail": "Block merge"
      },
      "description": "Execute automated CI/CD pipeline",
      "entry_criteria": [
        "PR review approved",
        "All feedback addressed"
      ],
      "exit_criteria": [
        "Build passes",
        "All tests pass",
        "Linting passes",
        "Security scan passes"
      ],
      "actions": [
        "Run automated tests",
        "Run linting and formatting",
        "Run security scans",
        "Build artifacts"
      ],
      "pipeline_checks": ["build", "unit_tests", "integration_tests", "lint", "security_scan", "type_check"],
      "mcp_tools": {
        "jira_mcp": ["add_comment"]
      },
      "handoff": {
        "to": "Human (Approval)",
        "payload": ["pipelineStatus", "checkResults"]
      }
    },
    {
      "step": 16,
      "name": "Human Merge Approval",
      "short_name": "Human Approval",
      "phase": "Merge & Deploy",
      "owner_agent": "Human",
      "wama_agents": [],
      "automated": false,
      "gate": {
        "type": "Human Gate",
        "description": "ONLY mandatory human intervention point",
        "action": "Approve or request changes"
      },
      "description": "Final human sign-off before merge",
      "entry_criteria": [
        "All automated checks pass",
        "Review approved",
        "No outstanding blockers"
      ],
      "exit_criteria": [
        "Human approves merge",
        "PR merged to target branch"
      ],
      "actions": [
        "Review PR summary",
        "Verify all checks pass",
        "Approve and merge"
      ],
      "approvers": ["tech_lead", "product_owner"],
      "important": "This is the ONLY mandatory human gate in the entire SDLC",
      "mcp_tools": {},
      "handoff": {
        "to": "PM Agent (Closure)",
        "payload": ["mergeCommit", "targetBranch"]
      }
    },
    {
      "step": 17,
      "name": "Story Closure",
      "short_name": "Close Story",
      "phase": "Merge & Deploy",
      "owner_agent": "PM Agent",
      "wama_agents": ["a-project-manager"],
      "automated": true,
      "gate": null,
      "description": "Close task, log work time, and ensure complete cross-linking between artifacts",
      "entry_criteria": [
        "PR merged",
        "Deployment successful (if applicable)"
      ],
      "exit_criteria": [
        "JIRA task marked as Done",
        "Work time logged (MANDATORY)",
        "PR link added to JIRA ticket",
        "Confluence documentation updated with PR link",
        "Confluence link added to JIRA ticket",
        "Release tagged (if applicable)"
      ],
      "actions": [
        "1. LOG WORK TIME - Call add_worklog with time spent on task",
        "2. ADD PR LINK - Add PR URL as comment/link in JIRA ticket",
        "3. UPDATE CONFLUENCE - Add PR link to documentation page",
        "4. LINK CONFLUENCE TO JIRA - Add Confluence page URL to JIRA ticket",
        "5. TRANSITION JIRA - Move ticket to Done status",
        "6. TAG RELEASE - Tag release if applicable",
        "7. SELECT NEXT STORY - Pick next story from backlog"
      ],
      "cross_linking": {
        "description": "Ensures all artifacts are interconnected for easy navigation",
        "mandatory_links": [
          {
            "from": "JIRA Ticket",
            "to": "GitHub PR",
            "tool": "add_comment",
            "format": "PR: {pr_url}"
          },
          {
            "from": "JIRA Ticket",
            "to": "Confluence Page",
            "tool": "add_comment",
            "format": "Documentation: {confluence_url}"
          },
          {
            "from": "Confluence Page",
            "to": "GitHub PR",
            "tool": "update_page",
            "format": "Include PR link in Implementation section"
          }
        ],
        "optional_links": [
          {
            "from": "GitHub PR",
            "to": "JIRA Ticket",
            "note": "Usually auto-linked via PR title containing JIRA key"
          }
        ]
      },
      "worklog_requirement": {
        "mandatory": true,
        "description": "MUST log actual time spent on the task before marking Done",
        "mcp_call": {
          "tool": "add_worklog",
          "arguments": {
            "issueKey": "{jira_ticket}",
            "timeSpent": "Time in format: 1h 30m, 2d, 45m",
            "comment": "Brief description of work completed"
          }
        },
        "validation": "Check that worklog entry exists for the current session",
        "why_required": [
          "Enables sprint velocity tracking",
          "Provides data for future estimation",
          "Creates accountability trail",
          "Supports project reporting"
        ]
      },
      "jira_transition": "In Progress -> Done",
      "mcp_tools": {
        "jira_mcp": ["get_issue_details", "transition_issue", "add_comment", "add_worklog", "link_page_to_jira_issue"],
        "confluence_mcp": ["create_page", "update_page", "link_page_to_jira_issue"]
      },
      "completion_checklist": [
        "✅ Work time logged via add_worklog",
        "✅ PR URL added to JIRA ticket description or comment",
        "✅ Confluence documentation created/updated",
        "✅ Confluence URL added to JIRA ticket",
        "✅ JIRA ticket transitioned to Done",
        "✅ All findings from 4-Angle Review addressed (no blocking issues)"
      ],
      "handoff": {
        "to": "PM Agent (Step 1) - Next Story",
        "payload": ["completedTaskKey", "nextTaskKey", "sprintProgress", "timeLogged"]
      }
    }
  ],

  "storage_schemas": {
    "findings_per_task": {
      "location": ".reviews/findings/{task_id}_findings.json",
      "schema": {
        "schema_version": "1.0.0",
        "task_id": "string",
        "task_summary": "string",
        "review_date": "ISO8601 timestamp",
        "reviews": {
          "architecture": { "agent": "string", "findings": ["Finding[]"] },
          "security": { "agent": "string", "findings": ["Finding[]"] },
          "code_quality": { "agent": "string", "findings": ["Finding[]"] },
          "tech_stack": { "agent": "string", "findings": ["Finding[]"] }
        },
        "summary": {
          "critical": "number",
          "high": "number",
          "medium": "number",
          "low": "number",
          "total_found": "number",
          "total_fixed": "number"
        }
      }
    },
    "lessons_learned": {
      "location": ".reviews/lessons_learned.json",
      "schema": {
        "schema_version": "1.0.0",
        "last_updated": "ISO8601 timestamp",
        "total_reviews": "number",
        "total_findings": "number",
        "categories": {
          "security": { "total_count": "number", "common_issues": ["CommonIssue[]"] },
          "architecture": { "total_count": "number", "common_issues": ["CommonIssue[]"] },
          "code_quality": { "total_count": "number", "common_issues": ["CommonIssue[]"] },
          "tech_stack": { "total_count": "number", "common_issues": ["CommonIssue[]"] }
        },
        "top_lessons": ["Lesson[]"]
      },
      "purpose": "LLM learning context - load at start of each implementation"
    },
    "test_cases": {
      "location": "tests/cases/{task_id}.json",
      "schema": {
        "id": "TC-{task_id}-{sequence}",
        "title": "string",
        "description": "string",
        "type": "unit | integration | e2e",
        "priority": "critical | high | medium | low",
        "preconditions": ["string[]"],
        "steps": [{ "step_number": "number", "action": "string", "expected_result": "string" }],
        "jira_link": "string",
        "automation_status": "manual | automated | pending",
        "automation_path": "string"
      },
      "format": "TCM-compatible"
    }
  },

  "inter_agent_handoff_format": {
    "schema": {
      "from": "Agent role (string)",
      "to": "Target agent role (string)",
      "messageType": "handoff",
      "timestamp": "ISO 8601 timestamp",
      "step": "Current step number",
      "payload": {}
    }
  },

  "escalation_protocol": {
    "triggers": [
      "Quality score below 7/10 after 3 attempts",
      "Test pass rate below 90% after 3 retries",
      "CI/CD pipeline fails 3 times",
      "Critical/High issues remain after 3 fix attempts",
      "Security vulnerability found (auto-escalate)"
    ],
    "escalation_to": "Human + Coordinator Agent (a-architect-review)",
    "required_information": [
      "Failed step number and name",
      "Number of retry attempts",
      "Failure reason",
      "Suggested remediation"
    ]
  },

  "recommended_tools_by_step": {
    "1": {"mcp": "JIRA MCP", "tools": ["search_issues", "transition_issue", "add_comment"]},
    "2": {"mcp": "Enhanced Context MCP", "tools": ["load_enhanced_context"]},
    "3": {"mcp": "Enhanced Context MCP", "tools": ["load_vishkar_agent"], "agent": "a-architect-review"},
    "4": {"mcp": "Enhanced Context MCP", "tools": ["load_vishkar_agent"], "agent": "a-security-auditor"},
    "5": {"mcp": "Enhanced Context MCP", "tools": ["load_vishkar_agent"], "agent": "a-code-reviewer"},
    "6": {"mcp": "Enhanced Context MCP", "tools": ["get_contextual_agent", "load_vishkar_agent"], "agent": "contextual"},
    "7": {"mcp": "Enhanced Context MCP + JIRA", "tools": ["load_enhanced_context", "add_comment"]},
    "8": {"mcp": "JIRA MCP", "tools": ["add_comment"]},
    "9": {"mcp": "JIRA MCP + Enhanced Context", "tools": ["get_issue_details", "load_enhanced_context"]},
    "10": {"mcp": "Enhanced Context MCP", "tools": ["load_enhanced_context"]},
    "11": {"mcp": "JIRA MCP", "tools": ["add_comment"]},
    "12": {"mcp": "JIRA MCP", "tools": ["add_comment"]},
    "13": {"mcp": "PR-Agent MCP (Docker localhost:8188)", "tools": ["pr_describe", "pr_review", "pr_improve"]},
    "14": {"mcp": "JIRA MCP", "tools": ["add_comment"]},
    "15": {"mcp": "External CI/CD", "tools": []},
    "16": {"mcp": "Human", "tools": []},
    "17": {"mcp": "JIRA MCP + Confluence MCP", "tools": ["transition_issue", "add_comment", "add_worklog", "update_page"]}
  }
}
