Required Improvements for Phase 2

  1. Story Prioritization Context (NEW)

  When query_type = "story" or "implementation", return prioritization rules:

  ## Story Prioritization Rules

  ### Priority Order (Highest to Lowest):
  1. **In Progress** - Stories already started (continue momentum)
  2. **Blocked Unblocked** - Recently unblocked stories waiting
  3. **Sprint Committed** - Stories in current sprint
  4. **Epic Deadline** - Parent epic has approaching deadline
  5. **High Priority** - P1/Highest priority stories
  6. **Assigned to User** - Stories assigned to current user
  7. **Dependencies Clear** - Stories with no blocking dependencies

  ### JQL Query Pattern:
  ```jql
  project = {PROJECT_KEY}
  AND status NOT IN (Done, Closed, Resolved)
  AND (
    status = "In Progress"
    OR (sprint IN openSprints() AND assignee = currentUser())
    OR priority IN (Highest, High)
  )
  ORDER BY
    CASE status WHEN "In Progress" THEN 1 ELSE 2 END,
    priority DESC,
    updated DESC

  Recommended Next Story Selection:

  - First: Any "In Progress" story (finish what you started)
  - Second: Sprint-committed story with highest priority
  - Third: Story blocking other stories
  - Fourth: Highest priority unassigned story

  ---

  #### 2. **Implementation Context** (NEW query_type: "implementation")
  For when developer asks "implement this story" or starts coding:

  ```markdown
  ## Implementation Context

  ### Pre-Implementation Checklist:
  - [ ] Story requirements understood
  - [ ] Acceptance criteria reviewed
  - [ ] Technical design reviewed (if major feature)
  - [ ] Dependencies identified
  - [ ] Branch created from latest main

  ### Implementation Flow:
  1. Transition story to "In Progress"
  2. Create feature branch: `feature/{STORY_KEY}-short-description`
  3. Implement following TDD approach
  4. Run local tests before commit
  5. Create PR when ready

  ### Code Quality Gates:
  - Lint passing
  - Unit tests >90% coverage
  - No security vulnerabilities
  - Type safety (TypeScript strict)

  ---
  3. Sprint Context (NEW)

  Return current sprint information when available:

  {
    "sprint": {
      "name": "Sprint 23",
      "startDate": "2025-12-01",
      "endDate": "2025-12-14",
      "daysRemaining": 11,
      "committedStories": 8,
      "completedStories": 3,
      "inProgressStories": 2
    }
  }

  ---
  4. Project-Specific Overrides

  Load from project registry based on API key:

  {
    "project": {
      "key": "P360V2",
      "jiraBaseUrl": "https://bounteous.jira.com",
      "defaultAssignee": "prem.kalyan@bounteous.com",
      "techStack": ["Next.js", "FastAPI", "PostgreSQL", "Prisma"],
      "branchNamingPattern": "feature/{storyKey}-{shortDescription}",
      "prTemplate": "default",
      "customPrioritization": null
    }
  }

  ---
  5. Query Type Expansion

  Add new query types for Phase 2:

  | Query Type     | Use Case             | Returns                                    |
  |----------------|----------------------|--------------------------------------------|
  | story          | Story breakdown      | Story template, INVEST criteria            |
  | implementation | Start coding         | Pre-impl checklist, branch naming          |
  | next-story     | What to work on next | Prioritization rules, JQL pattern          |
  | pr-review      | PR ready for review  | 3-phase review process                     |
  | testing        | Write tests          | Test strategy, coverage targets            |
  | deployment     | Deploy to env        | CI/CD checklist, rollback plan             |
  | blocker        | Story is blocked     | Escalation process, communication template |

  ---
  6. Agent Selection Enhancement

  Map query types to recommended agents:

  {
    "agentMapping": {
      "next-story": "project-manager",
      "implementation": "backend-engineer OR frontend-developer",
      "pr-review": "pr-orchestrator",
      "testing": "test-automator",
      "security": "security-auditor",
      "architecture": "backend-architect"
    }
  }

  ---
  7. MCP Tool Availability

  Return available MCP tools with connection status:

  {
    "mcpTools": {
      "jira": {
        "available": true,
        "serverName": "jira-orengrinker",
        "tools": ["search_issues", "get_issue_details", "transition_issue", "add_comment"]
      },
      "github": {
        "available": true,
        "tools": ["create_pr", "get_pr_status", "merge_pr"]
      },
      "confluence": {
        "available": false,
        "setupRequired": "CONFLUENCE_SPACE_KEY, CONFLUENCE_BASE_URL"
      }
    }
  }

  ---
  8. Contextual Templates

  Return appropriate template based on query:

  | Query Type     | Template                         |
  |----------------|----------------------------------|
  | next-story     | t-story-selection (NEW)          |
  | implementation | t-implementation-checklist (NEW) |
  | pr-review      | t-pr-review-process              |
  | testing        | t-test-strategy                  |
  | blocker        | t-blocker-communication (NEW)    |

  ---
  API Response Structure Enhancement

  {
    "success": true,
    "tool": "load_enhanced_context",
    "result": {
      "queryType": "next-story",
      "contextCombination": "Story Selection & Prioritization",

      "prioritization": {
        "rules": [...],
        "jqlPattern": "...",
        "recommendedOrder": [...]
      },

      "sprint": {
        "name": "Sprint 23",
        "daysRemaining": 11,
        "velocity": 21
      },

      "project": {
        "key": "P360V2",
        "techStack": [...],
        "conventions": {...}
      },

      "agent": {
        "recommended": "project-manager",
        "available": [...]
      },

      "mcpTools": {
        "jira": { "available": true, "tools": [...] },
        "github": { "available": true },
        "confluence": { "available": false }
      },

      "templates": ["t-story-selection"],
      "contexts": ["c-core-sdlc", "c-jira-management", "c-story-prioritization"],

      "guidance": {
        "nextSteps": [...],
        "bestPractices": [...],
        "commonMistakes": [...]
      }
    }
  }

  ---
  Summary of Changes Needed:

  1. New Context Files (in ~/.wama/contexts/):
    - c-story-prioritization.md - Prioritization rules
    - c-implementation-flow.md - Implementation checklist
    - c-sprint-management.md - Sprint context
  2. New Templates (in ~/.wama/templates/):
    - t-story-selection.md - For next-story selection
    - t-implementation-checklist.md - Pre-coding checklist
    - t-blocker-communication.md - Escalation template
  3. New Query Types:
    - next-story - What to work on
    - implementation - Start coding
    - blocker - Handle blockers
    - deployment - Deploy changes
  4. Project Registry Integration:
    - Load project-specific config from registry
    - Return project conventions, tech stack
    - Custom prioritization rules per project
  5. MCP Tool Status:
    - Return which tools are available
    - Show setup requirements for missing tools

  ---
  Want me to create the context files and implement these changes?
